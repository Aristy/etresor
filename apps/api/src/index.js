import 'dotenv/config'; import express from 'express'; import cors from 'cors'; import helmet from 'helmet'; import morgan from 'morgan'; import { PrismaClient } from '@prisma/client'; import { genRef, computeTotals } from './utils.js';
const app=express(), prisma=new PrismaClient(), PORT=process.env.PORT||8090;
app.use(helmet()); app.use(cors()); app.use(express.json({limit:'1mb'})); app.use(morgan('dev'));
app.get('/health',(req,res)=>res.json({ok:true}));
app.post('/auth/login',(req,res)=>res.json({token:'demo-token',user:{username:(req.body||{}).username||'demo'}}));
app.get('/services',async(req,res)=>res.json(await prisma.service.findMany({where:{active:true},orderBy:{id:'asc'}})));
app.post('/invoices',async(req,res)=>{const {niu,serviceId,amount}=req.body||{}; if(!niu||!serviceId||!amount) return res.status(400).json({error:'niu, serviceId, amount requis'}); const svc=await prisma.service.findUnique({where:{id:Number(serviceId)}}); if(!svc) return res.status(404).json({error:'Service introuvable'}); const {amt,tva,fee,total}=computeTotals({amount,tvaPct:svc.tvaPct,feeFixed:svc.feeFixed,feePct:svc.feePct}); const ref=genRef(); const invoice=await prisma.invoice.create({data:{ref,niu,serviceId:svc.id,amount:amt,tva,fee,total,status:'PENDING'}}); res.json(invoice);});
app.post('/payments/init',async(req,res)=>{const {ref,method,msisdn,amount}=req.body||{}; if(!ref||!method||!amount) return res.status(400).json({error:'ref, method, amount requis'}); const inv=await prisma.invoice.findUnique({where:{ref}}); if(!inv) return res.status(404).json({error:'Facture introuvable'}); const payRef=ref; const payment=await prisma.payment.upsert({where:{ref:payRef},update:{method,msisdn,amount:Number(amount),status:'PENDING'},create:{ref:payRef,invoiceId:inv.id,method,msisdn,amount:Number(amount),status:'PENDING'}}); if(method==='MOMO'){setTimeout(async()=>{await prisma.payment.update({where:{ref:payRef},data:{status:'PAID',tx:`tx_${Date.now()}`}}).catch(()=>{}); await prisma.invoice.update({where:{id:inv.id},data:{status:'PAID'}}).catch(()=>{}); console.log(`[SIM] Payment ${payRef} marked PAID`);},5000);} res.json(payment);});
app.get('/payments/:ref',async(req,res)=>{const p=await prisma.payment.findUnique({where:{ref:req.params.ref}}); if(!p) return res.status(404).json({error:'Paiement introuvable'}); res.json(p);});
app.get('/receipts/:ref',async(req,res)=>{const inv=await prisma.invoice.findUnique({where:{ref:req.params.ref},include:{service:true,payments:true}}); if(!inv) return res.status(404).json({error:'Facture introuvable'}); res.json({ref:inv.ref,niu:inv.niu,service:{code:inv.service.code,name:inv.service.name},amounts:{amount:inv.amount,tva:inv.tva,fee:inv.fee,total:inv.total,currency:'XAF'},status:inv.status,payments:inv.payments});});
app.listen(PORT,()=>console.log(`eTresor API Palier1 on :${PORT}`));